// ─────────────────────────────────────────────
// Smart Schematic Analysis Platform — Prisma Schema
// ─────────────────────────────────────────────

generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ── NextAuth.js Models ──────────────────────

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?   // For credentials provider
  tier          UserTier  @default(FREE)

  accounts   Account[]
  sessions   Session[]
  schematics Schematic[]
  usage      Usage?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ── Application Models ──────────────────────

model Schematic {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  fileName  String
  fileUrl   String           // S3/R2 path
  fileSize  Int
  pageCount Int              @default(0)
  status    ProcessingStatus @default(UPLOADED)

  pages      SchematicPage[]
  components Component[]
  bomItems   BomItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model SchematicPage {
  id          String    @id @default(cuid())
  schematicId String
  schematic   Schematic @relation(fields: [schematicId], references: [id], onDelete: Cascade)
  pageNumber  Int
  imageUrl    String    // Rasterized page image URL
  width       Int
  height      Int

  components  Component[]
  textBlocks  TextBlock[]
  connections Json?       // JSONB connectivity graph

  @@unique([schematicId, pageNumber])
}

model Component {
  id            String        @id @default(cuid())
  schematicId   String
  schematic     Schematic     @relation(fields: [schematicId], references: [id], onDelete: Cascade)
  pageId        String
  page          SchematicPage @relation(fields: [pageId], references: [id], onDelete: Cascade)
  type          String        // resistor, capacitor, IC, etc.
  refDesignator String?       // R1, C2, U3, etc.
  value         String?       // 10kΩ, 100nF, etc.
  confidence    Float         // AI confidence score (0-1)
  bbox          Json          // {x, y, width, height}
  attributes    Json?         // Additional parsed attributes

  @@index([schematicId])
  @@index([type])
  @@index([refDesignator])
}

model TextBlock {
  id         String        @id @default(cuid())
  pageId     String
  page       SchematicPage @relation(fields: [pageId], references: [id], onDelete: Cascade)
  text       String
  confidence Float
  bbox       Json
  category   TextCategory  @default(LABEL)

  @@index([pageId])
}

model BomItem {
  id            String    @id @default(cuid())
  schematicId   String
  schematic     Schematic @relation(fields: [schematicId], references: [id], onDelete: Cascade)
  refDesignator String
  componentType String
  value         String?
  footprint     String?
  quantity      Int       @default(1)
  partNumber    String?
  price         Float?
  inStock       Boolean?

  @@index([schematicId])
}

model Usage {
  id                 String @id @default(cuid())
  userId             String @unique
  user               User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  schematicsUploaded Int    @default(0)
  pagesProcessed     Int    @default(0)
  searchesPerformed  Int    @default(0)

  resetAt   DateTime @default(now()) // Monthly reset
  updatedAt DateTime @updatedAt
}

// ── Enums ───────────────────────────────────

enum UserTier {
  FREE
  BASIC
  PROFESSIONAL
  TEAM
}

enum ProcessingStatus {
  UPLOADED
  PROCESSING
  COMPLETED
  FAILED
}

enum TextCategory {
  LABEL
  VALUE
  PIN
  TITLE
  NOTE
}
